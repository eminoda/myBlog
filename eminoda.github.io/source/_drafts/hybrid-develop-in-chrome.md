---
title: 混合开发中“丢掉真机”，直接在浏览器调试
tags:
  - hybrid
categories:
  - 开发
  - 前端开发
---

# 混合开发来带的“负担”

之前我所接触的混合开发模式比较简单：

> 原生 APP 只提供 webview 的壳子，界面由 H5 提供，内部逻辑均是 H5 闭环处理。

其实 APP 就是充当浏览器的功能，在实际开发中也没有遇到阻碍。

但在近期开发的项目中，H5 需要和 原生 APP 进行交互（调用摄像头，存储等功能），目前这些都有成熟的解决方案，简单说：APP 在 webview 提供 window 全局的方法，H5 直接在代码中调用即可；如果涉及异步的回调，则在前端实现一套事件监听机制就行了（其中细节不是本篇的讨论重点）。

虽然技术难点都能解决，但还是出现了不可忽视的问题：

> 开发模式负担加重

原先在网页端，配合开发者工具（F12），前端开发起来很轻量，改动代码刷新页面后立马看到效果。而现在需要拿着“真机”开发，中间的网络请求，代码逻辑，异常错误统统都看不到。虽然可以借助 [微信 vConsole](https://github.com/Tencent/vConsole) 能解决大部分问题，但毕竟**在两个设备之间注意力不停切换，极大的影响了开发效率和体验**。

# 浏览器调试策略

## 放弃真机

最影响效率的原因，就是多了一台设备。所以，第一步就是放弃真机的调试模式。想办法将开发中需要的一切从新挪回至开发电脑的浏览器中。

{% asset_img hybrid1.jpg 放弃真机调试 %}

马上就面对第一个难题：脱离真机后，怎么调用原生 APP 的那些 SDK 方法？

{% asset_img hybrid2.jpg 如何调用 SDK %}

## 改写 SDK 调用

页面中，所有涉及 SDK 调用的逻辑均改为 XHR 方式，这样就回归到网页的开发方式。

通过固定的请求地址前缀转发所有的 SDK 请求到 SDK 代理服务（见下文）。

## SDK 工具页

实现一个专门处理 SDK 方法调用的页面，页面中通过 websocket 机制建立 SDK 代理服务与此工具页的通讯。

APP 内嵌 H5 页面改为此工具页，websocket 接受到的 SDK 方法名和参数均原封不动的交给 SDK 执行，最后将结果回告给代理服务。

## SDK 代理服务

选用 nodejs 轻量搭建代理服务

在这个代理服务中也启动一个 websocket 监听，用来给 SDK 工具页发送 SDK 调用数据及接受处理结果数据。
