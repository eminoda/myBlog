---
title: 数据库日期类型在 sequelize 的使用
tags: sequelize
categories:
  - 开发
  - 前端开发
---

# 前言

对于前端虽说有 Node.js 加持，能胜任多平台的产品开发，但因为不是主攻后端，一些数据库知识点偏弱，加上使用 sequelize 等库开箱即用的 api，使得某些细节处理不当很容易导致一些问题。

这篇就谈谈时间（时区）相关的概念，数据库中日期类型，以及结合 sequelize 的实际使用心得。

# 几种时间约定

## GMT 格林威治标准时间

> 格林尼治平均时间（Greenwich Mean Time，GMT）是指位于英国伦敦郊区的皇家格林尼治天文台当地的平太阳时，因为本初子午线被定义为通过那里的经线。

为了形象理解，找了张时区的地理图：

{% asset_img timezone.jpg %}

能看到整个地球被花费为 24 个时区，以

## ISO 8601

> 国际标准 ISO 8601，是国际标准化组织的日期和时间的表示方法，全称为《数据存储和交换形式·信息交换·日期和时间的表示方法》。

格式：**YYYY-MM-DDTHH:mm:ss.sssZ**

## UTC

## GMT

# 数据库中的日期类型

先看下数据库有日期类型，以及他们的特点：

| 类型      | 长度    | 日期格式            | 日期范围                                  | 特殊                                |
| --------- | ------- | ------------------- | ----------------------------------------- | ----------------------------------- |
| DATETIME  | 8 bytes | YYYY-MM-DD HH:MM:SS | 1000-01-01 00:00:00 ~ 9999-12-31 23:59:59 | 不涉及时区（依照数据源原样存储）    |
| TIMESTAMP | 4 bytes | YYYY-MM-DD HH:MM:SS | 1970-01-01 00:00:01 ~ 2038                | 涉及时区（将当地时间转为 UTC 储存） |
| TIME      | 3 bytes | HH:MM:SS            | -838:59:59~838:59:59                      | -                                   |
| DATE      | 3 bytes | YYYY-MM-DD          | 1000-01-01 ~ 9999-12-31                   | -                                   |
| YEAR      | 1 bytes | YYYY                | 1901 ~ 2155                               | -                                   |

能看到对 **DATETIME** 和 **TIMESTAMP** 做了特殊说明，他们两者在和 **sequelize** 一起使用时必然会遇到些问题，下面通过一个例子来说明。

# sequelize 中的日期类型

## Demo

首先创建 **time_diff** 表，创建不同的日期类型字段：

```js
+-------------+-------------+------+-----+---------+----------+
| Field       | Type        | Null | Key | Default | Extra    |
+-------------+-------------+------+-----+---------+----------+
| source_time | varchar(60) | YES  |     | NULL    |          |
| t_date      | date        | YES  |     | NULL    |          |
| t_datetime  | datetime    | YES  |     | NULL    |          |
| t_timestamp | timestamp   | YES  |     | NULL    |          |
+-------------+-------------+------+-----+---------+----------+
```

然后通过 **Model.create** 往该表插入一条数据（每列赋值均为 **new Date** ）

```js
// 模型定义
const TimeDiff = sequelize.define(
  'TimeDiff',
  {
    sourceTime: DataTypes.STRING,
    tDate: DataTypes.DATE,
    tDatetime: DataTypes.DATE,
    tTimestamp: DataTypes.DATE,
  },
  {
    freezeTableName: true,
    tableName: 'time_diff',
    timestamps: false,
    underscored: true,
  }
);

const time = new Date();
console.log('time', time);

// 新增记录
TimeDiff.create({
  sourceTime: time.toString(),
  tDate: time,
  tDatetime: time,
  tTimestamp: time,
});
```

结果能看到虽然在 sequelize 中对每列的值设置都一样,但实际却不同:

```
+-----------------------------------------------+------------+---------------------+---------------------+
| source_time                                   | t_date     | t_datetime          | t_timestamp         |
+-----------------------------------------------+------------+---------------------+---------------------+
| Mon Nov 09 2020 21:25:32 GMT+0800 (GMT+08:00) | 2020-11-09 | 2020-11-09 13:25:32 | 2020-11-09 21:25:32 |
+-----------------------------------------------+------------+---------------------+---------------------+
```

能看到 **t_date** 只展示了年月日 **YYYY-MM-DD** ， **t_datetime** 和 **t_timestamp** 虽然日期格式都为 **YYYY-MM-DD HH:mm:ss** ，但之间相差 8 小时，那怎么将他们入库时时区相同呢？

## 时区设置

那就要在 sequelize 设置制定时区了：

```js
const config = {
  database: 'ebone',
  username: 'root',
  password: 'root',
};

const options = {
  host: '127.0.0.1',
  dialect: 'mysql',
  timezone: '+08:00', // 时区设置
};

const sequelize = new Sequelize(config.database, config.username, config.password, options);
```

设置完毕后，我们再插入一条数据将发现这两个字段时区相同了：

```
+-----------------------------------------------+------------+---------------------+---------------------+
| source_time                                   | t_date     | t_datetime          | t_timestamp         |
+-----------------------------------------------+------------+---------------------+---------------------+
| Mon Nov 09 2020 21:25:32 GMT+0800 (GMT+08:00) | 2020-11-09 | 2020-11-09 13:25:32 | 2020-11-09 21:25:32 |
| Mon Nov 09 2020 21:37:20 GMT+0800 (GMT+08:00) | 2020-11-09 | 2020-11-09 21:37:20 | 2020-11-09 21:37:20 |
+-----------------------------------------------+------------+---------------------+---------------------+
```

## 查询的“不同”

除了插入行数据，当我们查询记录时，能看到更有意思的现象（**不设置 sequelize 时区选项**）：

```js
TimeDiff.findAll({
  raw: true,
}).then((data) => {
  console.log(data);
});
```

```js
[
  // 未设置时区时，新增的数据
  {
    sourceTime: 'Mon Nov 09 2020 21:25:32 GMT+0800 (GMT+08:00)',
    tDate: '2020-11-09',
    tDatetime: '2020-11-09T13:25:32.000Z',
    tTimestamp: '2020-11-09T13:25:32.000Z', // 好像少了 8 小时
  },
  // 已设置时区候，新增的数据
  {
    sourceTime: 'Mon Nov 09 2020 21:37:20 GMT+0800 (GMT+08:00)',
    tDate: '2020-11-09',
    tDatetime: '2020-11-09T21:37:20.000Z',
    tTimestamp: '2020-11-09T13:37:20.000Z', // 好像少了 8 小时
  },
];
```

能看到之前新增的数据（设置时区前后），TIMESTAMP 类型少了 8 小时。

而当我们重新设置时区（+8:00）后，DATETIME 类型被减少 8 小时。

```js
[
  {
    sourceTime: 'Mon Nov 09 2020 21:25:32 GMT+0800 (GMT+08:00)',
    tDate: '2020-11-09',
    tDatetime: '2020-11-09T05:25:32.000Z', // 好像少了 8 小时
    tTimestamp: '2020-11-09T13:25:32.000Z',
  },
  {
    sourceTime: 'Mon Nov 09 2020 21:37:20 GMT+0800 (GMT+08:00)',
    tDate: '2020-11-09',
    tDatetime: '2020-11-09T13:37:20.000Z', // 好像少了 8 小时
    tTimestamp: '2020-11-09T13:37:20.000Z', // 好像少了 8 小时
  },
];
```

## 设置字符串

```js
const time = moment().format('YYYY-MM:DD HH:mm:ss');
```

```
+-----------------------------------------------+------------+---------------------+---------------------+
| source_time                                   | t_date     | t_datetime          | t_timestamp         |
+-----------------------------------------------+------------+---------------------+---------------------+
| Mon Nov 09 2020 21:25:32 GMT+0800 (GMT+08:00) | 2020-11-09 | 2020-11-09 13:25:32 | 2020-11-09 21:25:32 |
| Mon Nov 09 2020 21:37:20 GMT+0800 (GMT+08:00) | 2020-11-09 | 2020-11-09 21:37:20 | 2020-11-09 21:37:20 |
| 2020-11:09 23:21:37                           | 2020-11-09 | 2020-11-09 23:21:37 | 2020-11-09 23:21:37 |
+-----------------------------------------------+------------+---------------------+---------------------+
```
